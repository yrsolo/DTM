name: Deploy Yandex Cloud Function (main)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Contract regression smoke checks
        run: |
          python agent/read_model_contract_compat_smoke.py
          python agent/schema_snapshot_smoke.py

      - name: Preflight required variables
        shell: bash
        env:
          YC_LOCKBOX_SECRET_ID: ${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}
          YC_SERVICE_ACCOUNT_ID: ${{ vars.YC_SERVICE_ACCOUNT_ID || secrets.YC_SERVICE_ACCOUNT_ID }}
          YC_RUNTIME_SERVICE_ACCOUNT_ID: ${{ vars.YC_RUNTIME_SERVICE_ACCOUNT_ID || secrets.YC_RUNTIME_SERVICE_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${YC_LOCKBOX_SECRET_ID}" ]; then
            echo "Missing required repository variable: YC_LOCKBOX_SECRET_ID" >&2
            exit 1
          fi
          if [ -z "${YC_SERVICE_ACCOUNT_ID}" ] && [ -z "${YC_RUNTIME_SERVICE_ACCOUNT_ID}" ]; then
            echo "Missing runtime service account variable: set YC_RUNTIME_SERVICE_ACCOUNT_ID or YC_SERVICE_ACCOUNT_ID" >&2
            exit 1
          fi

      - name: Deploy function version
        id: deploy
        uses: yc-actions/yc-sls-function@v4
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          folder-id: ${{ vars.YC_FOLDER_ID || secrets.YC_FOLDER_ID }}
          function-name: ${{ vars.YC_CLOUD_FUNCTION_NAME || secrets.YC_CLOUD_FUNCTION_NAME }}
          runtime: ${{ vars.YC_FUNCTION_RUNTIME || 'python311' }}
          memory: ${{ vars.YC_FUNCTION_MEMORY || '512Mb' }}
          execution-timeout: ${{ vars.YC_FUNCTION_TIMEOUT || '60s' }}
          entrypoint: ${{ vars.YC_FUNCTION_ENTRYPOINT || secrets.YC_FUNCTION_ENTRYPOINT || 'index.handler' }}
          service-account: ${{ vars.YC_RUNTIME_SERVICE_ACCOUNT_ID || secrets.YC_RUNTIME_SERVICE_ACCOUNT_ID || vars.YC_SERVICE_ACCOUNT_ID || secrets.YC_SERVICE_ACCOUNT_ID }}
          environment: |
            ENV=${{ vars.ENV || 'prod' }}
            SOURCE_SHEET_NAME=${{ vars.SOURCE_SHEET_NAME || 'Спонсорские ТНТ' }}
            TARGET_SHEET_NAME=${{ vars.TARGET_SHEET_NAME || 'Спонсорские ТНТ ТЕСТ' }}
            STRICT_ENV_GUARD=${{ vars.STRICT_ENV_GUARD || '1' }}
          secrets: |
            TG_TOKEN=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/TG_TOKEN
            OPENAI_TOKEN=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/OPENAI_TOKEN
            ORG_TOKEN=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/ORG_TOKEN
            PROXY_URL=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/PROXY_URL
            GOOGLE_KEY_JSON=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/GOOGLE_KEY_JSON
            DEFAULT_CHAT_ID=${{ vars.YC_LOCKBOX_SECRET_ID || secrets.YC_LOCKBOX_SECRET_ID }}/latest/DEFAULT_CHAT_ID
          include: |
            **/*.py
            requirements.txt
            run_timer.cmd
            AGENTS.md
            README.md
            doc/**/*.md
            agile/**/*.md
          exclude: |
            .env
            .env.*
            .venv/**
            venv/**
            artifacts/**
            old/**
            .git/**
            .github/**
            **/__pycache__/**
            **/*.ipynb

      - name: Deployment summary
        if: always()
        run: |
          echo "Function deploy action finished."
          echo "Function: ${{ vars.YC_CLOUD_FUNCTION_NAME }}"
          echo "Entrypoint: ${{ vars.YC_FUNCTION_ENTRYPOINT }}"
