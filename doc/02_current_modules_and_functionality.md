# Модули и текущий функционал

## Точки входа

## `main.py`
- Определяет режим запуска (`timer`, `morning`, `test`) по event/trigger.
- Создает `GoogleSheetPlanner`.
- В режиме `timer/test`:
  - обновляет данные;
  - перерисовывает листы `Задачи`, `Календарь`, `Дизайнеры`.
- В режиме `morning/test`:
  - формирует и отправляет напоминания.

## `index.py`
- Обертка для Yandex Cloud.
- Вызывает `main(event=...)`.
- Ловит исключения и шлет подробности в Telegram лог-чат.

## Конфигурация

## `config/constants.py`
- Токены/секреты из `.env`.
- `SHEET_NAME` и карта листов (`SHEET_NAMES`).
- Маппинги колонок задач и людей (`TASK_FIELD_MAP`, `PEOPLE_FIELD_MAP`).
- Правила статуса по цвету (`COLOR_STATUS`).
- Палитра цветов для записи в таблицы (`COLORS`).
- Промпт персонажа для GPT (`HELPER_CHARACTER`), модель (`MODEL`), прокси (`PROXIES`).
- Триггеры облачных событий (`TRIGGERS`).

## Домен и обработка задач

## `core/repository.py`
- `TimingParser`: парсинг поля "Тайминг" в словарь `date -> stages`.
- `Task`: объект задачи, ленивый доступ к распарсенному таймингу.
- `GoogleSheetsTaskRepository`:
  - читает задачи из Google Sheets;
  - читает цвет ячеек первой колонки;
  - вычисляет `color_status`;
  - нормализует поле дизайнеров;
  - строит `Task`.

## `core/manager.py`
- `TaskManager`:
  - обновление коллекции задач;
  - генерация листа `Дизайнеры`.
- `TaskTimingProcessor`:
  - преобразование задач в структуру тайминга для календарей.
- `CalendarManager`:
  - формирование и запись листа `Календарь`.
- `TaskCalendarManager`:
  - формирование и запись листа `Задачи`.

## Люди и уведомления

## `core/people.py`
- `Person`, `Designer`.
- `PeopleManager`:
  - загрузка справочника людей с листа `Люди`;
  - поиск сотрудника по имени.

## `core/reminder.py`
- `TelegramNotifier`: отправка сообщений в Telegram + логирование.
- `AsyncOpenAIChatAgent`: вызов OpenAI для улучшения текста.
- `Reminder`:
  - расчет дат "сегодня/следующий рабочий день";
  - группировка задач по дизайнерам;
  - сбор черновика;
  - улучшение текста через OpenAI;
  - отправка по chat_id сотрудника.

## Инфраструктура и утилиты

## `utils/service.py`
- Низкоуровневый клиент Google Sheets/Drive:
  - поиск spreadsheet id по имени;
  - чтение значений в DataFrame;
  - чтение цветов ячеек;
  - batch update ячеек;
  - очистка диапазонов.

## `utils/func.py`
- Работа с цветами, парсинг диапазонов, фильтрация стадий.

## Фактический поток данных
1. Чтение `ТАБЛИЧКА` + цвета строк.
2. Нормализация/парсинг задач.
3. Генерация производных представлений:
   - `Дизайнеры`
   - `Календарь`
   - `Задачи`
4. Чтение `Люди`.
5. Генерация и отправка утренних сообщений.

## Узкие места для реконструкции
- Нет разделения "таблица для чтения" и "таблица для записи".
- Смешение доменной логики, форматирования и API-адаптеров.
- Нет регрессионного тестового контура на реальных данных таблицы.
