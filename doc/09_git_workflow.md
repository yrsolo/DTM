# Git Workflow

## Цель
- Предсказуемая и безопасная разработка без случайных поломок в `main`.

## Ветки
- `main`: только стабильное состояние, пригодное к запуску.
- `dev`: основная ветка разработки и интеграции.
- `feature/*`: короткоживущие ветки под отдельные задачи (опционально, если работа идет не напрямую в `dev`).
- `hotfix/*`: срочные исправления продовых инцидентов.

## Базовый процесс
1. Новая задача начинается от `dev` (или отдельной `feature/*` от `dev`).
2. Изменения коммитятся маленькими логическими порциями.
3. Перед merge обязательно:
- локальный запуск критического сценария (`run_timer.cmd` для timer-пайплайна);
- проверка, что секреты не попали в git;
- обновление docs, если изменили поведение/архитектуру/конфиги.
4. Merge в `dev`.
5. Merge `dev -> main` только после smoke-проверки на тестовой таблице.
6. Push в `origin/main`.

## Когда можно сливать в `main`
- Таймер-сценарий проходит без ошибок.
- Выходные листы в `TARGET` выглядят корректно (структура/цвета/даты/ноты не сломаны).
- Нет незапланированных изменений в боевой таблице.
- Нет утечек секретов в diff.
- Документация актуальна для сделанных изменений.

## Когда нельзя сливать в `main`
- Есть runtime-ошибки в `timer`.
- Изменения не проверены на реальных данных Sheets.
- Есть сомнение по безопасности (токены, ключи, proxy credentials, PII).
- Есть незавершенные миграции без rollback-плана.

## Commit policy
- Формат: короткий императивный заголовок на английском.
- Один коммит = одна логическая цель.
- Примеры:
  - `fix timer pipeline crash on empty timing`
  - `split source and target sheets for safe sync`
  - `refresh docs for DTM runtime and architecture`

## Merge policy
- Предпочтительно `fast-forward` для `dev -> main` (чистая история).
- Не делать force-push в `main`.
- Не делать `rebase` публичной ветки `main` после публикации.

## Hotfix policy
1. Ветка `hotfix/*` от `main`.
2. Минимальный фикс + проверка.
3. Merge в `main`, push.
4. Обязательно обратный merge `main -> dev`, чтобы не потерять фикс.

## Минимальный релизный чеклист
- `git status` чистый.
- `run_timer.cmd` успешен.
- Проверены ключевые листы в `TARGET`.
- Проверены `.env`, `key/*`, `old/*` на секреты.
- Обновлены docs (`doc/*`) при изменениях поведения.
