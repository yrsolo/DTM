# Designers's Task Manager - текущее описание проекта

## Назначение
Сервис автоматизирует управление задачами дизайн-отдела на основе Google Sheets:
- читает таблицу с задачами;
- парсит тайминги и этапы;
- строит 2 рабочих представления (по дизайнерам и по задачам);
- отправляет утренние напоминания дизайнерам в Telegram;
- использует OpenAI для стилизации текста напоминаний.

## Текущий runtime-контур
- Основной запуск: `main.py`
- Облачный запуск (Yandex Cloud handler): `index.py`
- Основной orchestration-объект: `GoogleSheetPlanner` (`core/planner.py`)
- Контур окружения:
  - базовые переменные загружаются из `.env`;
  - при наличии автоматически подгружается профиль `.env.<ENV>`;
  - допустимые `ENV`: `dev`, `test`, `prod`.

## Интеграции
- Google Sheets / Google Drive API (чтение/запись таблиц, цвета, заметки)
- Telegram Bot API (рассылка и логирование ошибок)
- OpenAI API (улучшение черновиков напоминаний)

## Входные/выходные листы Google таблицы
По текущим константам используются листы:
- `ТАБЛИЧКА` (основные задачи)
- `Дизайнеры` (представление задач по дизайнерам)
- `Календарь` (представление задач по датам/дизайнерам)
- `Задачи` (таймлайн по задачам)
- `Люди` (справочник сотрудников и чатов)

## Важное про безопасную реконструкцию
- Сейчас в `config/constants.py` используется явное разделение:
  - `SOURCE_SHEET_NAME` - источник данных (обычно боевая таблица),
  - `TARGET_SHEET_NAME` - витрина для записи (обычно тестовая таблица).
- Планировщик читает данные из `SOURCE`, а записывает листы визуализации в `TARGET`.
- Это позволяет безопасно отлаживать и рефакторить логику без риска испортить боевую витрину.
- Введен опциональный guard: при `STRICT_ENV_GUARD=1` и `ENV=dev/test` значения `SOURCE_SHEET_NAME` и `TARGET_SHEET_NAME` не могут совпадать (fail-fast).

## Текущие сильные стороны
- Продукт уже рабочий и используется в процессе.
- Есть единый пайплайн "прочитал -> преобразовал -> визуализировал -> напомнил".
- Логирование критических ошибок в Telegram присутствует.

## Текущие системные проблемы
- Сильная связанность бизнес-логики и интеграций.
- Низкая тестопригодность (нет автоматизированного тестового контура).
- Много "магических" правил и констант в одном месте.
- Низкая формализация регрессионной проверки визуализации (эталонные снимки/диффы пока вручную).

## 2026-02-28 update
- Added group-chat request path: when bot is mentioned/commanded in Telegram group, it replies in the same chat with current tasks or nearest deadlines.
- Added optional env key `TG_BOT_USERNAME` for mention-based parsing.
